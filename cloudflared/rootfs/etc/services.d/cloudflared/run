#!/usr/bin/with-contenv bashio
# ==============================================================================
# Start the cloudflared service
# s6-overlay docs: https://github.com/just-containers/s6-overlay
# ==============================================================================

# Declare variables
declare tunnel_token

# Get the 'tunnel_token' key from the user config options
tunnel_token=$(bashio::config 'tunnel_token')

# Check if tunnel token is provided
if [[ -z "${tunnel_token}" ]]; then
  bashio::log.fatal "No tunnel token configured!"
  bashio::log.fatal "Please configure a tunnel token in the add-on configuration."
  exit 1
fi

bashio::log.info "Starting Cloudflare Tunnel..."

# Write token to a temporary file for security (avoids exposing in process list)
echo -n "${tunnel_token}" > /tmp/cloudflared-token
chmod 600 /tmp/cloudflared-token

# Run cloudflared with token file
exec cloudflared tunnel --no-autoupdate run --token-file /tmp/cloudflared-token
